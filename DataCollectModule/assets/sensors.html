<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
    
    <head>
        <title>Accelerometer Javascript Test</title>
        <meta name="viewport" content="width=device-width,user-scalable=yes" />

        <script type="text/javascript">
                
	        var id = 1;
			var url = "http://192.168.1.105:3001/";
			var method = "POST";
			var async = true;	
	        
			function startRequest(postData){
				var request = new XMLHttpRequest();
			    request.onreadystatechange = function() {
					if (request.readyState == 4) {	// 4 = finished
						document.getElementById("status").innerHTML = request.status;
					}
				};
				request.open(method, url, async);
                request.setRequestHeader("Content-Type", "application/json;charset=UTF-8");
				request.send(postData);
			}
			
			function createJSONString(name, params, values){
					
				var json = {};
				json["id"] = ++id;
				json["type"] = "simple";
				json["name"] = name;
				json["params"] = params;
				var array = [];
				array[0] = values;
				json["values"] = array;
				console.log(JSON.stringify(json));
				return JSON.stringify(json);
			}
 
 			// --- Accelerometer and Rotation
            if (window.DeviceMotionEvent != undefined) {
                window.ondevicemotion = function (e) {
					var accX = e.accelerationIncludingGravity.x;
					var accY = e.accelerationIncludingGravity.y;
					var accZ = e.accelerationIncludingGravity.z;
                    document.getElementById("accelerationX").innerHTML = accX;
                    document.getElementById("accelerationY").innerHTML = accY;
                    document.getElementById("accelerationZ").innerHTML = accZ;
					
                    if (e.rotationRate) {
						var rotA = e.rotationRate.alpha;
						var rotB = e.rotationRate.beta;
						var rotC = e.rotationRate.gamma;
                        document.getElementById("rotationAlpha").innerHTML = rotA;
                        document.getElementById("rotationBeta").innerHTML = rotB;
                        document.getElementById("rotationGamma").innerHTML = rotC;
						
						//no rotation in android app
						var ms = new Date().getTime();
						var params = ["rotA","rotB","rotC","timestamp"];
						var values = [rotA, rotB, rotC, ms];
						startRequest(createJSONString("RotationData", params, values));
                    }
                    
					var ms = new Date().getTime();
					var params = ["accX","accY","accZ","timestamp"];
					var values = [accX, accY, accZ, ms];
					startRequest(createJSONString("AccelerationData", params, values));
                }
            }

			// --- Light sensor
            window.addEventListener('devicelight', function(e) {
            	document.getElementById("lightSensor").innerHTML = e.value;
				var ms = new Date().getTime();
				var params = ["lx","timestamp"];
				var values = [e.value, ms];
				startRequest(createJSONString("LightData", params, values));
			});

			// --- Proximity
			window.addEventListener('deviceproximity', function(e) {
			    document.getElementById("proximity").innerHTML = e.value;

			    //no proximity in the android app
				var ms = new Date().getTime();
				var params = ["proximity","timestamp"];
				var values = [e.value, ms];
				startRequest(createJSONString("ProximityData", params, values));
			});


            // --- GeoLocation
            if (navigator.geolocation) {
			    navigator.geolocation.getCurrentPosition(success, fail);
			}

			function success(position) {
				var lat = position.coords.latitude;
				var lon = position.coords.longitude;
				document.getElementById("geoLocation").innerHTML = 'Latitude: '+ lat + ', Longitude: '+ lon;

				var ms = new Date().getTime();				
				var params = ["latitude","longitude","timestamp"];
				var values = [lat, lon, ms];
				var json = createJSONString("LocationData", params, values);
				startRequest(json);
			}

			function fail() {
				alert('No gelocation device');
			}

			// --- Battery
			var battery = navigator.battery || navigator.mozBattery;

			if (battery != null) {
				battery.addEventListener('chargingchange', updateStatus);  
			}

			function updateStatus() { 
				var batteryP = battery.level * 100;
				document.getElementById("battery").innerHTML = ' ' + batteryP + ' %';
				if (battery.charging) {
				alert('Phone is charging');   
				}
			  
			    //battery data does not exist in android app
			  	var ms = new Date().getTime();
				var params = ["battery","timestamp"];
				var values = [batteryP, ms];
				startRequest(createJSONString("BatteryData", params, values));
			}  

        </script>

    </head>
    
    <body>
        <div id="content">
            
		<h1>Mobile HTML sensor test</h1>

            <div id="sphere"></div>
            <ul>
                <li>acceleration x: <span id="accelerationX"></span>g</li>
                <li>acceleration y: <span id="accelerationY"></span>g</li>
                <li>acceleration z: <span id="accelerationZ"></span>g</li>
                <li>rotation alpha: <span id="rotationAlpha"></span>degree</li>
                <li>rotation beta: <span id="rotationBeta"></span>degree</li>
                <li>rotation gamma: <span id="rotationGamma"></span>degree</li>
                <li>Light sensor: <span id="lightSensor"></span>lux</li>
                <li>Proximity: <span id="proximity"></span></li>
                <li>GeoLocation: <span id="geoLocation"></span></li>
                <li>Battery status: <span id="battery"></span></li>
				<br/>
				<li>Request status: <span id="status"></span></li>
            </ul>
			<br/>
			<br/>

			Source: <a href="http://atleast.aut.bme.hu/mobilesensors"/>
			<br/>
        </div>

    </body>

</html>